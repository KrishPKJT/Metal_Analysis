{% extends 'base.html' %}
    {% block content %}
<!-- Page Content Starts Here -->
        <div class="page-content">
            <div class="page-container">
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-head d-flex align-items-sm-center flex-sm-row flex-column">
                            <div class="flex-grow-1">
                                <h4 class="fs-18 fw-semibold m-0">Body Parts</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card card-h-100">
                                    <div
                                        class="card-header d-flex flex-wrap align-items-center gap-2 border-bottom border-dashed">
                                        <h4 class="header-title me-auto">Body Parts</h4>
                                        <h4 class="header-title text-right"><i class="ti ti-plus" data-bs-toggle="modal" data-bs-target="#body-parts-modal" style="font-size:25px" id="reset_body"></i></h4>

                                    </div>

                                    <div class="card-body p-3">
                                       
                                    <div class="table-responsive-sm">
                                    <table class="table table-striped table-hover mb-0" id="bodyPartsTable">
                                        <thead>
                                            <tr>
                                                <th style="width:10%">#</th>
                                                <th>Parts</th>
                                               
                                            </tr>
                                        </thead>
                                        <tbody>
                                          
                                            
                                        </tbody>
                                    </table>
                                </div>

                                    </div> 
                                </div> 
                            </div>
                         
                         
                             <div class="col-md-6">
                                <div class="card card-h-100">
                                    <div
                                        class="card-header d-flex flex-wrap align-items-center gap-2 border-bottom border-dashed">
                                        <h4 class="header-title me-auto">Object</h4>
                                        <h4 class="header-title text-right"><i class="ti ti-plus" data-bs-toggle="modal" data-bs-target="#object-modal" style="font-size:25px" id="reset_Object"></i></h4>
                                    </div>

                                    <div class="card-body p-3">
                                    <div class="table-responsive-sm">
                                    <table class="table table-striped table-hover mb-0" id="objectTable">
                                        <thead>
                                            <tr>
                                                <th style="width:10%">#</th>
                                                <th>Object name</th>
                                                <th>Body part</th>
                                                <th>Gender</th>
                                                <th style="width:15%;text-align:center">Action</th>
                                              
                                            </tr>
                                        </thead>
                                        <tbody>
                                          
                                        </tbody>
                                    </table>
                                </div>
                                    </div> 
                                </div> 
                            </div>
                        </div>
                    </div> 
                </div> 
            </div> 
        </div>


<div class="modal fade" id="body-parts-modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
<div class="modal-dialog modal-md">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="">Body Parts</h4>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">

<form id="bodyparts_form">
<div class="row">
<div class="col-md-10">

<label for="" class="form-label">Body Parts</label>
<input type="text" id="body_parts_name" name="body_parts_name" class="form-control" autocomplete="off">
</div>
<div class="col-md-2 mt-3">
<button class="btn btn-success" type="submit" id="bodysavebutton" style="margin-top:5px">Save</button>
</div>
</div>
</form>

</div>
</div>
</div>
</div>

<div class="modal fade" id="object-modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="">Object Mapping</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="object_form">
                    <div class="row">
                        <input type="hidden" class="form-control" autocomplete="off" id="object_id" >
                        <div class="col-md-12">
                            <label for="" class="form-label">Object Name</label>
                            <input type="text" id="object_name" name="object_name" class="form-control" autocomplete="off">
                        </div>

                        <div class="mt-2">
                            <label for="" class="form-label">Gender</label><br/>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" value="Male" id="gender_male">
                                <label class="form-check-label" for="gender_male">Male</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" value="Female" id="gender_female">
                                <label class="form-check-label" for="gender_female">Female</label>
                            </div>
                        </div>
                        
                      

                        <div class="col-md-12 mt-3">
                            <label for="" class="form-label">Body Parts</label>
                            <select class="form-select" id="body_parts" name="body_parts"></select>
                        </div>

                        <div class="col-md-12 mt-3 pull-right">
                            <button class="btn btn-success" style="margin-top:5px" type="submit" id="objectsavebutton">Save</button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title" id="deleteModalTitle">Delete</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="deleteModalBody">
            Are you sure you want to delete this item?
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
        </div>
    </div>
</div>





  


{% endblock %}
{%block javascripts %}
<script src="{{request.root}}static/js/dataTables.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $.ajaxSetup({
    statusCode: {
        401: function(jqXHR) {
            // Log the status for debugging
            console.log("401 response received:", jqXHR);

            // Attempt to parse the response text as JSON
            try {
                const data = JSON.parse(jqXHR.responseText);
                alert(data.message);  // Notify the user
                window.location.href = data.redirect;  // Redirect to login page
            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        }
    }
});
        getobjectgender();
    var partstable = $('#bodyPartsTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
         "searching": false,
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
        "ajax": {
            "url": "/bodyparts/getbody-partlist",
            "type": 'POST',
            "dataSrc": "data"
        },
        "columns": [
            { 
                "data": null, 
                "render": function(data, type, row, meta) {
                    return meta.row + 1; 
                }
            },
            { 
                "data": "body_parts_name"  
            },
        
        ]
   
    });

    var objecttable = $('#objectTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
         "searching": false,
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
        "ajax": {
            "url": "/object/getobject-list",
            "type": 'POST',
            "dataSrc": "data"
        },
        "columns": [
            { 
                "data": null, 
                "render": function(data, type, row, meta) {
                    return meta.row + 1; 
                }
            },
            { "data": "object_name"},
            { "data": "body_parts_name"},
            { "data": "gender"},
            { 
                "data": null,
                "render": function(data, type, row) {
                // Check if the id is 1
                if (row.id === 1) {
                return ''; // Return empty string to hide buttons
                }
                // Otherwise, return the action buttons
                return `
                <a href="javascript:void(0);" class="link-reset fs-20 p-1 editObjectBtn" data-id="${row.id}">
                <i class="ti ti-pencil"></i>
                </a>
                <a href="javascript:void(0);" class="link-reset fs-20 p-1 deleteObjectBtn" data-id="${row.id}">
                <i class="ti ti-trash"></i>
                </a>
                `;
                }
            }
        
        ]
   
    });


    

    $("body").on("submit", "#bodyparts_form", function(e) {
    e.preventDefault();
    var form = $(this);
    
    // Create FormData object to handle form data
    const formData = new FormData();
    formData.append('body_parts_name', form.find("#body_parts_name").val());

    // Use $.ajax to send the form data
    $.ajax({
        url: "/bodyparts/save",  // The endpoint URL
        type: 'POST',  // HTTP method
        data: formData,  // Data to send
        processData: false,  // Prevent jQuery from processing the data
        contentType: false,  // Prevent jQuery from setting content type header
        success: function(result) {
            if (result.status === 'ok') {             
                $("#body-parts-modal").modal('hide');
                partstable.ajax.reload();  // Reload table data
                alert('Saved/Updated successfully');
            } else {
                alert('Failed: something went wrong');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log('AJAX error:', jqXHR.status);
            //alert('Something went wrong');
        }
    });
});
    $("#reset_body").on("click", function() {
        $('#body_parts_name').val('');
      
    });
    $("#reset_Object").on("click",function()
    {
        $('#object_name').val('');
        $('#body_parts').val('')
        $('input[type="checkbox"]').prop('checked', false);
        getbodypartlist();
    })
    $('#object_form').on('submit', function(e) {
    e.preventDefault();
    var objectName = $('#object_name').val();
    var selectedGenders = [];
    if ($('#gender_male').is(':checked')) {
        selectedGenders.push('male');
    }
    if ($('#gender_female').is(':checked')) {
        selectedGenders.push('female');
    }

    var genderString = selectedGenders.join(',');   
    var bodyPart = $('#body_parts').val();
    var objectId = $('#object_id').val();
    
    var formData = {
        id: objectId,
        object_name: objectName,
        gender: genderString,
        body_parts_name: bodyPart
    };

  
    $.ajax({
        url: '/object/save', 
        type: 'POST',
        data: formData,
        success: function(response) {
            if (response.status === 'ok') {
                objecttable.ajax.reload();
                alert('Object saved successfully!');
                 $('#object-modal').modal('hide');
            } else {
                alert('Error saving object!');
            }
        },
        error: function() {
            console.log('Error submitting the form!');
        }
    });
});
$(document).on('click', '.deleteObjectBtn', function() {
        deleteObjectId = $(this).data('id'); 
        $('#delete-modal').modal('show'); 
    });  
function getbodypartlist()
    {
        $.ajax({
            url: '/bodyparts/list', // Flask route to fetch building data
            type: 'GET',
            success: function(response) {
                if (response.data) {
                    var buildingDropdown = $('#body_parts');
                    buildingDropdown.empty(); 
                    buildingDropdown.append('<option value="">Select parts</option>');                     
                    $.each(response.data, function(index, bodypart) {
                        buildingDropdown.append('<option value="' + bodypart.id + '">' + bodypart.body_parts_name + '</option>');
                    });

                  
                }
            },
            error: function() {
                alert('Error loading body parts data');
            }
        });
   
    }
function getobjectgender()
    {
    // var body_part = $('#body_part').val();
    // var gender = $('#gender').val();
    var body_part = "Neck";
    var gender = "female";

    $.ajax({
        url: '/object/getgender-object-list',
        type: 'POST',
        data: { body_part: body_part, gender: gender },
        success: function(data) {
            // Clear the current table content
            
        }
    });
}
$('#objectTable').on('click', '.editObjectBtn', function() {
        var objectid = $(this).data('id');  
        getbodypartlist();   
        $('#objectsavebutton').text('Update');
        $.ajax({
            url: '/bodyparts/object/get/' + objectid,  
            type: 'GET',
            success: function(data) {
                if (data.status === 'ok') {                       
                    $('#object_id').val(data.object_data.id); 
                    $('#object_name').val(data.object_data.object_name); 
                    $('#body_parts').val(data.object_data.body_part_id);                 
                    var genders = data.object_data.gender.split(',');
                    $('#gender_male').prop('checked', genders.includes('male'));
                    $('#gender_female').prop('checked', genders.includes('female'));

              
                $('#object-modal').modal('show');
                } else {
                    alert('Failed to fetch Object Mapping data.');
                }
            },
            error: function() {
                alert('Error fetching Object Mapping data.');
            }
        });
    });
    $('#confirmDelete').on('click', function() {
    $.ajax({
        url: '/object/delete/' + deleteObjectId, // Use the ID of the object to delete
        type: 'DELETE',
        success: function(response) {
            if (response.status === 'ok') {
              
                objecttable.ajax.reload(); 
                alert(response.message); 
                $('#delete-modal').modal('hide'); 
            } else {
                alert('Error deleting object: ' + response.message);
            }
        },
        error: function() {
            alert('Error deleting the object.');
        }
    });
});
});

</script>
{% endblock %}