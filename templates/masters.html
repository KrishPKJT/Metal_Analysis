{% extends 'base.html' %}
    {% block content %}
<!-- Page Content Starts Here -->
        <div class="page-content">
            <div class="page-container">
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-head d-flex align-items-sm-center flex-sm-row flex-column">
                            <div class="flex-grow-1">
                                <h4 class="fs-18 fw-semibold m-0">Master</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card card-h-100">
                                    <div
                                        class="card-header d-flex flex-wrap align-items-center gap-2 border-bottom border-dashed">
                                        <h4 class="header-title me-auto">Building</h4>
                                        <h4 class="header-title text-right"><i class="ti ti-plus" data-bs-toggle="modal" data-bs-target="#building-modal" style="font-size:25px" id="reset_building"></i></h4>

                                    </div>

                                    <div class="card-body p-3">
                                       
                                    <div class="table-responsive-sm">
                                    <table class="table table-striped table-hover mb-0" id="buildingTable">
                                        <thead>
                                            <tr>
                                                <th style="width:10%">#</th>
                                                <th>Building Name</th>
                                                <th style="width:15%;text-align:center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                          
                                            
                                        </tbody>
                                    </table>
                                </div>

                                    </div> 
                                </div> 
                            </div>
                            <div class="col-md-6">
                                <div class="card card-h-100">
                                    <div
                                        class="card-header d-flex flex-wrap align-items-center gap-2 border-bottom border-dashed">
                                        <h4 class="header-title me-auto">Floor</h4>
                                        <h4 class="header-title text-right"><i class="ti ti-plus" data-bs-toggle="modal" data-bs-target="#floor-modal" style="font-size:25px" id="reset_Floor" ></i></h4>
                                    </div>

                                    <div class="card-body p-3">
                                      
                                    <div class="table-responsive-sm">
                                    <table class="table table-striped table-hover mb-0" id="floorTable">
                                        <thead>
                                            <tr>
                                                <th style="width:10%">#</th>
                                                <th>Building Name</th>
                                                <th>Floor Name</th>
                                                <th style="width:15%;text-align:center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            
                                            
                                        </tbody>
                                    </table>
                                </div>

                                    </div> 
                                </div> 
                            </div>
                            <div class="col-md-12">
                                <div class="card card-h-100">
                                    <div
                                        class="card-header d-flex flex-wrap align-items-center gap-2 border-bottom border-dashed">
                                        <h4 class="header-title me-auto">Station</h4>
                                        <h4 class="header-title text-right"><i class="ti ti-plus" data-bs-toggle="modal" data-bs-target="#station-modal" style="font-size:25px" id="reset_Station"></i></h4>
                                    </div>

                                    <div class="card-body p-3">
                                    <div class="table-responsive-sm">
                                    <table class="table table-striped table-hover mb-0" id="stationTable">
                                        <thead>
                                            <tr>
                                                <th style="width:10%">#</th>
                                                <th>Building Name</th>
                                                <th>Floor Name</th>
                                                <th>Station Name</th>
                                                <th style="width:15%;text-align:center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                          
                                        </tbody>
                                    </table>
                                </div>
                                    </div> 
                                </div> 
                            </div>
                            <!--  <div class="col-md-6">
                                <div class="card card-h-100">
                                    <div
                                        class="card-header d-flex flex-wrap align-items-center gap-2 border-bottom border-dashed">
                                        <h4 class="header-title me-auto">Object</h4>
                                        <h4 class="header-title text-right"><i class="ti ti-plus" data-bs-toggle="modal" data-bs-target="#station-modal" style="font-size:25px" id="reset_Station"></i></h4>
                                    </div>

                                    <div class="card-body p-3">
                                    <div class="table-responsive-sm">
                                    <table class="table table-striped table-hover mb-0" id="objectTable">
                                        <thead>
                                            <tr>
                                                <th style="width:10%">#</th>
                                                <th>Object name</th>
                                                <th>Body part</th>
                                                <th>Gender</th>
                                                <th style="width:15%;text-align:center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                          
                                        </tbody>
                                    </table>
                                </div>
                                    </div> 
                                </div> 
                            </div> -->
                        </div>
                    </div> 
                </div> 
            </div> 
        </div>


<div class="modal fade" id="building-modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
<div class="modal-dialog modal-md">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="">Building</h4>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">

<form id="building_form">
<div class="row">
<div class="col-md-9">
<input type="hidden" id="building_id" name="building_id"/>
<label for="" class="form-label">Building Name</label>
<input type="text" id="building_name" name="building_name" class="form-control" autocomplete="off">
</div>
<div class="col-md-2 mt-3">
<button class="btn btn-success" type="submit" id="buildsavebutton" style="margin-top:3px">Save</button>
</div>
</div>
</form>

</div>
</div>
</div>
</div>

<div class="modal fade" id="floor-modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
<div class="modal-dialog modal-md">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="">Floor</h4>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<form id="floor_form">
<div class="row">
    <input type="hidden" id="floor_id" >
    <div class="col-md-12">
    <label for="" class="form-label">Floor Name</label>
    <input type="text" id="floor_name" name="floor_name" class="form-control" autocomplete="off">
    </div>
    <div class="col-md-12 mt-3">
        <label for="" class="form-label">Select Building</label>
        <select class="form-select" id="build_id" name="build_id">
        
        </select>
    </div>

    <div class="col-md-12 mt-3 pull-right">
    <button class="btn btn-success" style="margin-top:5px" type="submit" id="floorsavebutton">Save</button>
    </div>

</div>
</form>
</div>
</div>
</div>
</div>

<div class="modal fade" id="station-modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
<div class="modal-dialog modal-md">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="">Station</h4>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<form id="station_form">
<div class="row">
<div class="col-md-12">
<input type="hidden" class="form-control" autocomplete="off" id="station_id" >
<label for="" class="form-label">Station Name</label>
<input type="text"  class="form-control" autocomplete="off" id="station_name" >
</div>
<div class="col-md-12 mt-3">
    <label for="" class="form-label">Select Building</label>
    <select class="form-select" id="build_station_id" name="build_station_id">

    </select>
</div>
<div class="col-md-12 mt-3">
        <label for="" class="form-label">Select Floor</label>
        <select class="form-select" id="floor_station_id" name="floor_station_id" >
        
        </select>
</div>

   


    <div class="col-md-12 mt-3 pull-right">
    <button class="btn btn-success" style="margin-top:5px" type="submit" id="stationsavebutton">Save</button>
    </div>

</div>
</form>
</div>
</div>
</div>
</div>


<div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title" id="deleteModalTitle">Delete</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="deleteModalBody">
            Are you sure you want to delete this item?
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
        </div>
    </div>
</div>
  


{% endblock %}
{%block javascripts %}
<script src="{{request.root}}static/js/dataTables.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $.ajaxSetup({
    statusCode: {
        401: function(jqXHR) {
            // Log the status for debugging
            console.log("401 response received:", jqXHR);

            // Attempt to parse the response text as JSON
            try {
                const data = JSON.parse(jqXHR.responseText);
                alert(data.message);  // Notify the user
                window.location.href = data.redirect;  // Redirect to login page
            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        }
    }
});

   
    var buildtbl = $('#buildingTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
         "searching": false,
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
        "ajax": {
            "url": "/building/get-list",
            "type": 'POST',
            "dataSrc": "data"
        },
        "columns": [
            { 
                "data": null, 
                "render": function(data, type, row, meta) {
                    return meta.row + 1; 
                }
            },
            { 
                "data": "building_name"  
            },
            { 
                "data": null,
                "render": function(data, type, row) {
                    return `
                    <a href="javascript:void(0);" class="link-reset fs-20 p-1 editBuildingBtn" data-id="${row.id}"><i class="ti ti-pencil"></i></a>
                    <a href="javascript:void(0);" class="link-reset fs-20 p-1 deleteBuildingBtn" data-id="${row.id}"><i class="ti ti-trash"></i></a>
                    `;
                }
            }
        ]
   
    });

    getbuildinglist();

    $("body").on("submit", "#building_form", function(e) {
        e.preventDefault();
        var form = $(this);
        const formData = {
            building_name: form.find("#building_name").val(),
            building_id: form.find("#building_id").val()
        };

        $.ajax({
            url: "/building/save",
            method: 'POST',
            data: formData,
            success: function(result) {
                if (result.status == 'ok') {
                    $("#building-modal").modal('hide');
                    buildtbl.ajax.reload();
                    alert('Saved/Updated successfully');
                } else {
                    alert('Failed: something went wrong');
                }
            },
            error: function(jqXHR) {
                console.log('AJAX error:', jqXHR.status);
            }
        });
    })
    $("#reset_building").on("click", function() {
        $('#building_id').val('');
        $('#building_name').val('');   
        $('#buildsavebutton').text('Save');
    });
    $('#buildingTable').on('click', '.editBuildingBtn', function() {
        var buildingId = $(this).data('id');
        $('#buildsavebutton').text('Update');
        // Fetch building data based on the id
        $.ajax({
            url: '/building/get/' + buildingId,  
            type: 'GET',
            success: function(data) {
                if (data.status === 'ok') {                    
                    $('#building_id').val(data.building.id);
                    $('#building_name').val(data.building.building_name);             
                    
                    $('#building-modal').modal('show');
                } else {
                    alert('Failed to fetch building data.');
                }
            },
            error: function() {
                alert('Error fetching building data.');
            }
        });
    });

    $(document).on('click', '.deleteBuildingBtn', function() {
        deleteBuildingId = $(this).data('id'); // Get building id
        $('#building-delete').modal('show'); // Show delete confirmation modal
    });

   
    
    function getbuildinglist()
    {
        $.ajax({
            url: '/building/list', // Flask route to fetch building data
            type: 'GET',
            success: function(response) {
                if (response.data) {
                    var buildingDropdown = $('#build_id');
                    buildingDropdown.empty(); 
                    buildingDropdown.append('<option value="">Select Building</option>');                     
                    $.each(response.data, function(index, building) {
                        buildingDropdown.append('<option value="' + building.id + '">' + building.building_name + '</option>');
                    });

                    var buildstationdropdown=$('#build_station_id');
                    buildstationdropdown.empty(); 
                    buildstationdropdown.append('<option value="">Select Building</option>');                     
                    $.each(response.data, function(index, building) {
                        buildstationdropdown.append('<option value="' + building.id + '">' + building.building_name + '</option>');
                    });
                }
            },
            error: function() {
                alert('Error loading building data');
            }
        });
   
    }

    $("body").on("submit", "#floor_form", function (e) {
    e.preventDefault(); 

    var form = $(this); 

 
    const formData = new FormData();
    formData.append('floor_id', form.find("#floor_id").val());
    formData.append('build_id', form.find("#build_id").val());
    formData.append('floor_name', form.find("#floor_name").val());


    $.ajax({
        url: "/floor/save", 
        type: 'POST',        
        data: formData,      
        processData: false,  
        contentType: false, 
        success: function(result) {  
            if (result.status === 'ok') {
                $("#floor-modal").modal('hide'); 
                alert('Saved/Updated successfully'); 
                floortable.ajax.reload(); 
            } else {
                alert('Failed: something went wrong'); 
            }
        },
        error: function(jqXHR, textStatus, errorThrown) { 
            console.log('AJAX error:', jqXHR.status);  
            
        }
    });
});


    $("#reset_Floor").on("click", function() {
        $('#floor_id').val('');
        $('#build_id').val('');   
        $('#floor_name').val('');  
        $('#floorsavebutton').text('Save');
        getbuildinglist();
    });
    var floortable=$('#floorTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
        "searching": false,
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
        "ajax": {
            "url": "/floor/get-list",
            "type": 'POST',
            "dataSrc": "data"
        },
        "columns": [
            { 
                "data": null, 
                "render": function(data, type, row, meta) {
                    return meta.row + 1; 
                }
            },
            { 
                "data": "building_name"  
            },
            { 
                "data": "floor_name"  
            },
            { 
                "data": null,
                "render": function(data, type, row) {
                    return `
                    <a href="javascript:void(0);" class="link-reset fs-20 p-1 editFloorBtn" data-id="${row.id}"><i class="ti ti-pencil"></i></a>
                    <a href="javascript:void(0);" class="link-reset fs-20 p-1 deleteFloorBtn" data-id="${row.id}"><i class="ti ti-trash"></i></a>
                    `;
                }
            }
        ]
   
    });


    $('#floorTable').on('click', '.editFloorBtn', function() {
        var floorId = $(this).data('id');     
        $('#floorsavebutton').text('Update');
        $.ajax({
            url: '/floor/get/' + floorId,  
            type: 'GET',
            success: function(data) {
                if (data.status === 'ok') {                    
                    $('#floor_id').val(data.floor.id);
                    $('#build_id').val(data.floor.building_id);             
                    $('#floor_name').val(data.floor.floor_name);
                    $('#floor-modal').modal('show');
                } else {
                    alert('Failed to fetch floor data.');
                }
            },
            error: function() {
                alert('Error fetching floor data.');
            }
        });
    });

    $(document).on('click', '.deleteBuildingBtn', function() {
        var buildingId = $(this).data('id');       
        $('#deleteModalTitle').text('Delete Building');
        $('#deleteModalBody').text('Are you sure you want to delete this building?');       
        $('#confirmDelete').data('type', 'building').data('id', buildingId);        
        $('#delete-modal').modal('show');
    });

    
    $(document).on('click', '.deleteFloorBtn', function() {
        var floorId = $(this).data('id');        
        $('#deleteModalTitle').text('Delete Floor');
        $('#deleteModalBody').text('Are you sure you want to delete this floor?');
        $('#confirmDelete').data('type', 'floor').data('id', floorId);       
        $('#delete-modal').modal('show');
    });

    
    $('#confirmDelete').click(function() {
        var deleteType = $(this).data('type'); 
        var id = $(this).data('id');         
        if (deleteType === 'building') {
              $.ajax({
                url: '/building/delete',
                type: 'POST',
                data: { id: id },
                success: function(response) {
                    if (response.status === 'ok') {
                        alert('Building deleted successfully!');
                        buildtbl.ajax.reload();
                    }
                    $('#delete-modal').modal('hide');
                }
            });
        } else if (deleteType === 'floor') {
                $.ajax({
                url: '/floor/delete',
                type: 'POST',
                data: { id: id },
                success: function(response) {
                    if (response.status === 'ok') {
                       alert('Floor deleted successfully!');
                       floortable.ajax.reload();
                    }
                    $('#delete-modal').modal('hide');
                }
            });
            
        }
        else if (deleteType === 'station') {
                $.ajax({
                url: '/station/delete',
                type: 'POST',
                data: { id: id },
                success: function(response) {
                    if (response.status === 'ok') {
                       alert('Station deleted successfully!');
                       stationtable.ajax.reload();
                    }
                    $('#delete-modal').modal('hide');
                }
            });
            
        }
    });

    $('#build_station_id').change(function() {
        var buildingId = $(this).val();      
       
       
        
        getfloor(buildingId);
    });
    $("#reset_Station").on("click", function() {
        $('#station_id').val('');
        $('#build_station_id').val('');   
        $('#station_name').val('');  
        $('#floor_station_id').val('');  
        $('#stationsavebutton').text('Save');
        getbuildinglist();
    });
    $("body").on("submit", "#station_form", function (e) {
    e.preventDefault();
    var form = $(this);

    // Create FormData object to hold form data
    const formData = new FormData();
    formData.append('station_id', form.find("#station_id").val());
    formData.append('build_station_id', form.find("#build_station_id").val());
    formData.append('station_name', form.find("#station_name").val());
    formData.append('floor_station_id', form.find("#floor_station_id").val());

    
    $.ajax({
        url: "/station/save",  
        type: 'POST',  
        data: formData,  
        processData: false,  
        contentType: false, 
        success: function(result) {
            if (result.status == 'ok') {
                $("#station-modal").modal('hide');
                alert('Saved/Updated successfully');
                stationtable.ajax.reload();  // Reload DataTable
            } else {
                console.log('Failed: something went wrong');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log('AJAX error:', jqXHR.status);
            
        }
    });
});

    var stationtable=$('#stationTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
        "searching": false,
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
        "ajax": {
            "url": "/station/get-list",
            "type": 'POST',
            "dataSrc": "data"
        },
        "columns": [
            { 
                "data": null, 
                "render": function(data, type, row, meta) {
                    return meta.row + 1; 
                }
            },
            { "data": "building_name"},
            { "data": "floor_name"},
            {"data" :"station_name"},
            { 
                "data": null,
                "render": function(data, type, row) {
                    return `
                    <a href="javascript:void(0);" class="link-reset fs-20 p-1 editStationBtn" data-id="${row.id}"><i class="ti ti-pencil"></i></a>
                    <a href="javascript:void(0);" class="link-reset fs-20 p-1 deleteStationBtn" data-id="${row.id}"><i class="ti ti-trash"></i></a>
                    `;
                }
            }
        ]
   
    });
    $('#stationTable').on('click', '.editStationBtn', function() {
        var stationId = $(this).data('id');     
        $('#stationsavebutton').text('Update');
        $.ajax({
            url: '/station/get/' + stationId,  
            type: 'GET',
            success: function(data) {
                if (data.status === 'ok') {                    
                    $('#station_id').val(data.station.id);
                    $('#build_station_id').val(data.station.building_id);             
                    $('#station_name').val(data.station.station_name);
                    getfloor(data.station.building_id, function() {
                   
                    $('#floor_station_id').val(data.station.floor_id);
                });                 
                    $('#station-modal').modal('show');
                } else {
                    alert('Failed to fetch station data.');
                }
            },
            error: function() {
                alert('Error fetching station data.');
            }
        });
    });

    function getfloor(buildingId,callback)
    {
        $('#floor_station_id').empty();
        $.ajax({
            url: '/floor/list', // Backend route to get floor data
            type: 'POST',
            data: { building_id: buildingId },
            success: function(response) {
                if (response.length > 0) {
                    // Populate the floor select box with the received floor data
                    $.each(response, function(index, floor) {
                        $('#floor_station_id').append(
                            $('<option></option>').val(floor.id).text(floor.floor_name)
                        );
                    });
                if (callback) {
                    callback();
                }
                } else {
                    $('#floor_station_id').append('<option>No floors available</option>');
                }
            },
            
            error: function() {
                console.error('Error fetching floor data');
            }
        });
    }

    $(document).on('click', '.deleteStationBtn', function() {
        var stationId = $(this).data('id');        
        $('#deleteModalTitle').text('Delete Station');
        $('#deleteModalBody').text('Are you sure you want to delete this station?');
        $('#confirmDelete').data('type', 'station').data('id', stationId);       
        $('#delete-modal').modal('show');
    });

    

});

</script>
{% endblock %}